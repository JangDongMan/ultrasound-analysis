# 초음파 피부층 경계 자동 검출 알고리즘 개선 리포트

## 요약

234개 수동 레이블 데이터의 통계 분석을 기반으로 개선된 자동 검출 알고리즘을 개발하였으며, 24개 테스트 샘플에 대해 평가한 결과 다음과 같은 성능을 달성했습니다:

- **진피(Dermis) 검출**: 평균 오차 **0.204 ± 0.185 mm** (< 1.0mm 정확도 **100%**)
- **근막(Fascia) 검출**: 평균 오차 **0.609 ± 0.504 mm** (< 1.0mm 정확도 **70.8%**)
- **양측 동시**: < 1.0mm 정확도 **70.8%**

---

## 1. 수동 레이블 통계 분석

### 1.1 데이터셋
- **총 샘플 수**: 234개
- **환자 수**: 3명 (bhjung, cmkim, Drpark)
- **측정 위치**: 각 8개 부위
- **레이블 마커**: T0 (피부 시작), T1 (진피), T2 (근막)

### 1.2 통계 결과 (T0 기준)

| 경계 | 평균 시간 (μs) | 평균 깊이 (mm) | 표준편차 (mm) |
|------|----------------|----------------|---------------|
| **진피 (Dermis)** | T0 + 2.33 ± 0.33 | 1.80 ± 0.25 | 0.25 |
| **근막 (Fascia)** | T0 + 5.16 ± 0.79 | 3.97 ± 0.61 | 0.61 |
| **두께 차이** | 2.83 ± 0.67 μs | 2.18 ± 0.59 | 0.59 |

### 1.3 권장 탐색 범위
- **진피**: 2.0 ~ 2.7 μs (평균 ± 1σ)
- **근막**: 4.4 ~ 5.9 μs (평균 ± 1σ)

---

## 2. 알고리즘 개선 과정

### 2.1 초기 문제점
기존 알고리즘은 단순히 **가장 높은 2개의 피크**를 선택했으나, 이는 다음 문제를 야기:
- 표피(Epidermis) 피크(~0.5μs, ±2.5V)가 포함되어 잘못된 경계 검출
- 24개 샘플 중 1~2개만 정확

### 2.2 개선 1차: 통계 기반 범위 제한
**문제**: 0.5V 이하로 떨어진 첫 지점부터 탐색했으나, 전압이 오래 낮게 유지되는 경우 너무 이른 시점 선택

**해결**: 예상 범위(2.0~2.7μs) 내에서만 탐색하도록 제한

**결과**: 개선되었으나 일부 케이스(bhjung pos1, pos7 등)에서 여전히 큰 오차

### 2.3 개선 2차: 시간 기반 표피 제외 (최종)
**문제**: 표피의 잔향(echo)이 오래 지속되어, 80% 임계값 기반 검출이 진피 영역까지 침범
- 예: 표피 끝 시간이 7.13μs로 검출되지만 실제 진피는 2.34μs

**해결**:
```python
# 1.5μs 이전을 표피 영역으로 간주하고 완전히 제외
epidermis_cutoff_time_us = 1.5
epidermis_end = np.argmin(np.abs(analysis_time_us - epidermis_cutoff_time_us))
```

**결과**: 진피 검출 오차 **56% 감소** (0.466mm → 0.204mm)

---

## 3. 최종 알고리즘 구조

### 3.1 진피(Dermis) 검출
```
1. 표피 제외: 1.5μs 이전 영역 완전 제외
2. 탐색 범위: 2.0 ~ 2.7 μs (통계 기반)
3. 방법:
   a. 절댓값의 기울기 변화(변곡점) 검출
   b. 상승 변곡점(음→양 전환) 중 예상 시간에 가장 가까운 지점 선택
   c. 변곡점이 없으면 피크 중 예상 시간에 가장 가까운 것 선택
```

### 3.2 근막(Fascia) 검출
```
1. 탐색 범위: 4.4 ~ 5.9 μs (통계 기반) 또는 진피 + 2.18mm
2. 방법:
   a. 두 예상값의 평균 사용
   b. 피크 검출 (prominence = std × 0.3)
   c. 예상 시간에 가장 가까운 피크 선택
```

### 3.3 폴백 메커니즘
표피 제외 또는 범위 설정에 실패한 경우, 기존 방식(상위 2개 피크)으로 폴백

---

## 4. 성능 평가 (N=24)

### 4.1 진피(Dermis) 검출

| 지표 | 값 |
|------|-----|
| **평균 오차** | 0.204 ± 0.185 mm |
| **중앙값 오차** | 0.146 mm |
| **최대 오차** | 0.601 mm |
| **시간 오차** | 0.265 ± 0.240 μs |

**정확도 분포**:
- < 0.2mm: 58.3% (14/24)
- < 0.3mm: 75.0% (18/24)
- < 0.5mm: 91.7% (22/24)
- < 1.0mm: **100.0% (24/24)** ✓

### 4.2 근막(Fascia) 검출

| 지표 | 값 |
|------|-----|
| **평균 오차** | 0.609 ± 0.504 mm |
| **중앙값 오차** | 0.431 mm |
| **최대 오차** | 1.756 mm |
| **시간 오차** | 0.790 ± 0.655 μs |

**정확도 분포**:
- < 0.2mm: 25.0% (6/24)
- < 0.3mm: 37.5% (9/24)
- < 0.5mm: 54.2% (13/24)
- < 1.0mm: 70.8% (17/24)

### 4.3 양측 동시 정확도

| 임계값 | 정확도 |
|--------|--------|
| < 0.5mm | 54.2% (13/24) |
| < 1.0mm | **70.8% (17/24)** |

---

## 5. 최악 케이스 분석

### 5.1 진피 검출 오차 Top 5

| 환자 | 위치 | 수동(mm) | 자동(mm) | 오차(mm) | 원인 |
|------|------|----------|----------|----------|------|
| bhjung | 4 | 2.38 | 1.78 | 0.60 | 예상 범위보다 깊은 진피 |
| Drpark | 4 | 1.30 | 1.84 | 0.54 | 예상 범위보다 얕은 진피 |
| cmkim | 4 | 2.25 | 1.76 | 0.49 | 예상 범위보다 깊은 진피 |
| Drpark | 1 | 2.39 | 1.93 | 0.45 | 예상 범위보다 깊은 진피 |
| bhjung | 2 | 1.53 | 1.96 | 0.43 | 예상 범위보다 얕은 진피 |

**분석**: Position 4가 3건 포함 → 특정 측정 부위에서 변이 큰 것으로 추정

### 5.2 근막 검출 오차 Top 5

| 환자 | 위치 | 수동(mm) | 자동(mm) | 오차(mm) | 원인 |
|------|------|----------|----------|----------|------|
| cmkim | 8 | 2.27 | 4.03 | 1.76 | 예상보다 얕은 근막 (이상치) |
| cmkim | 7 | 2.84 | 4.14 | 1.30 | 예상보다 얕은 근막 |
| Drpark | 4 | 3.10 | 4.38 | 1.28 | 예상보다 얕은 근막 |
| bhjung | 5 | 4.73 | 3.47 | 1.26 | 예상보다 깊은 근막 |
| bhjung | 4 | 4.62 | 3.37 | 1.25 | 예상보다 깊은 근막 |

**분석**: cmkim 환자의 pos7, pos8이 평균보다 얕은 근막을 가짐 (개인차)

---

## 6. 개선 전후 비교

| 지표 | 개선 전 | 개선 후 | 변화 |
|------|---------|---------|------|
| **Dermis 평균 오차** | 0.466 ± 0.462 mm | 0.204 ± 0.185 mm | **-56%** ↓ |
| **Dermis < 0.5mm** | 70.8% | 91.7% | **+21%** ↑ |
| **Dermis < 1.0mm** | 79.2% | 100.0% | **+21%** ↑ |
| **Fascia 평균 오차** | 0.666 ± 0.562 mm | 0.609 ± 0.504 mm | -9% ↓ |
| **Both < 1.0mm** | 62.5% | 70.8% | +8% ↑ |

---

## 7. 결론 및 향후 과제

### 7.1 주요 성과
1. ✅ **표피 제외 메커니즘**: 시간 기반 (1.5μs) 제외로 안정적 검출
2. ✅ **통계 기반 범위**: 234개 샘플 분석으로 신뢰성 있는 탐색 범위 확보
3. ✅ **진피 검출 100% 정확도**: 1mm 이내 오차로 모든 샘플 성공
4. ✅ **근막 검출 70.8% 정확도**: 1mm 이내 오차

### 7.2 향후 개선 방향

**근막 검출 정확도 향상**:
- 개인별/부위별 변이 고려 (cmkim pos7, pos8의 얕은 근막)
- 진피-근막 두께 비율 활용
- 신호 강도 패턴 분석 강화

**적응형 알고리즘**:
- 환자별 보정 파라미터 학습
- 측정 부위별 특성 반영

**CNN 모델 학습**:
- 개선된 자동 검출 결과를 CNN 학습 데이터로 활용
- 수동 레이블 + 개선된 자동 레이블 병합

---

## 8. 생성 파일

### 8.1 시각화 결과
- **경로**: `results/improved/`
- **파일 수**: 24개 (3 환자 × 8 위치)
- **형식**: PNG (300 DPI)
- **내용**: 4개 서브플롯
  1. 전체 신호 + 펄스 시작점
  2. T0 이후 신호 + 6mm 제한선
  3. 6mm 범위 원본 신호 + 검출 마커 (빨간색: 수동, 파란색: 자동)
  4. 전체 범위 원본 신호 + 검출 마커

### 8.2 관련 스크립트
- `visualize_signal_improved.py`: 개선된 시각화 및 검출 알고리즘
- `evaluate_detection_accuracy.py`: 정확도 평가
- `analyze_manual_labels.py`: 수동 레이블 통계 분석
- `debug_detection.py`: 디버깅용 상세 분석

---

**작성일**: 2026-01-07
**알고리즘 버전**: 2.0 (시간 기반 표피 제외 + 통계 범위 제한)
